---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

```{r}
require(dplyr)
require(ggplot2)
require(xts)
require(rugarch)
require(PerformanceAnalytics)
require(quantmod)
library(skewt)
```

```{r}
read_funds <- function(lf) {
  dfs <- list()
 browser()
  for (f in 1:length(lf)) {
      cond <- substr(lf[f], nchar(lf[f])-3, nchar(lf[f])) == '.csv'
      if (cond) {
      temp <- data.frame(read.csv(lf[f], stringsAsFactors = FALSE))
      temp$Date <- as.Date(temp$Date)
      temp$Close <- as.numeric(temp$Close)
      dfs[[f]] <- temp[,c(1,5)]
    }
  }
 
  return(dfs)
}

funds_names <- c("Vanguard", "Blackrock", "Statestreet", 
                     "JPmorgan", "Bankmellon", "Allianz")
```

```{r}
# Data loading
df <- read.csv('Funds.csv', stringsAsFactors = F)
df <- df[,-1]
df$Date <- as.Date(df$Date)

# Transforming data from df to xts
funds <- xts(df[,2:ncol(df)], order.by = df$Date)

rm(df)

# Subseting original data for April of 2020 year
funds_red <- funds['/202004']

```

```{r}
get_volatiles <- function(funds, width = 22, time_scale = 1, funds_names) {
    vol_df <- data.frame()
    
    for (i in 1:ncol(funds)) {
      fund <- funds[,i]
      temp <- rollapply(data = fund, width = 22, FUN = 'sd.annualized', scale = time_scale)
      
      if (nrow(vol_df) == 0) {
        vol_df <- temp
      } else {
        vol_df <- cbind(vol_df, temp)    
      }

    }
    names(vol_df) <- funds_names 
    return(vol_df)
}

visualize_funds_lines <- function(funds, y_axis_label = 'Volatility') {
  
  for (i in 1:ncol(funds)) {
    temp <- funds[,i]  
    temp_mean <- mean(temp, na.rm = TRUE)
    
    p <- ggplot(temp, aes(x = index(temp), y = temp)) + 
    geom_line(aes(color = 'Volatility')) +
    geom_hline(aes(yintercept = temp_mean, color = 'Mean'),
               size=.5, linetype='dashed') +
    geom_text( aes( min(index(temp)) , temp_mean, label = round(temp_mean, 4), vjust = 2)) +
    labs(x = 'Date', y = y_axis_label, title = names(funds)[i]) +
    theme(plot.title = element_text(hjust = 0.5))
    
    suppressMessages(suppressWarnings(print(p)))
  }
}

visualize_funds_hist <- function(funds, x_axis_label = 'Return') {
  for (i in 1:ncol(funds)) {
      temp <- funds[,i]  
      title <- paste(funds_names[i], 'returns')
      
      chart.Histogram(temp,
                methods = c('add.normal', 'add.density'), 
                main = title)
      
      temp <- (temp - mean(temp, na.rm = T))/sd(temp, na.rm = T)        
      title <- paste('Standardized', title)

      chart.Histogram(temp,
                      methods = c('add.normal', 'add.density'), 
                      main = title)
  }
}

```


```{r}
vol_df <- get_volatiles(funds, funds_names =  funds_names)

visualize_funds_lines(vol_df)
visualize_funds_hist(funds)
vanguard_tail_volatility <- tail(vol_df$Vanguard, 10)

```

```{r}
plot_acf <- function(fund) {
  f_mean <- mean(fund)
  acf(abs(f_mean))
}
```

```{r}
# In this chunk, prefix van_ - is for Vanguard company
fund <- funds$vanguard_return


# Forming set of parameters for different GARCH model
# The most important is distribution.model - we are specifying type of distribution 
# Standard GARCH with normal distribution of errors
norm_garch_spec <- ugarchspec(mean.model = list(armaOrder = c(0,0)),
                       variance.model = list(model = 'sGARCH'),
                       distribution.model = 'norm')

# GJR GARCH with normal distribution of errors
norm_gjr_spec <- ugarchspec(mean.model = list(armaOrder = c(0,0)),
                       variance.model = list(model = 'gjrGARCH'),
                       distribution.model = 'norm')

# Standard GARCH with skewed Student t distribution of errors
sstd_garch_spec <- ugarchspec(mean.model = list(armaOrder = c(0,0)),
                       variance.model = list(model = 'sGARCH'),
                       distribution.model = 'sstd')

# GJR GARCH with skewed Student t distribution of errors
sstd_gjr_spec <- ugarchspec(mean.model = list(armaOrder = c(0,0)),
                       variance.model = list(model = 'gjrGARCH'),
                       distribution.model = 'sstd')

garch_specs <- list(norm_garch_spec, norm_gjr_spec,
                     sstd_garch_spec, sstd_gjr_spec)

rm(norm_garch_spec, norm_gjr_spec, sstd_garch_spec, sstd_gjr_spec)
```


```{r}
# Models naming
model_names <- c('Standard GARCH with normal distribution of errors',
                         'GJR GARCH with normal distribution of errors',
                         'Standard GARCH with skewed Student t distribution of errors',
                         'GJR GARCH with skewed Student t distribution of errors')

short_model_names <- c('Normal GARCH', 'Normal GJR', 'Skewed t GARCH', 'Skewed t GJR')

names(garch_specs) <- model_names
```


```{r}
# Apply GARCH model to our data
garch_fits <- list()

for (s in 1:length(garch_specs)) {
  suppressWarnings(garch_fits[s] <- ugarchfit(data = fund,
                                              spec = garch_specs[[s]]))
}
rm(s)
names(garch_fits) <- model_names

# rm(norm_garch_fit, norm_gjr_fit, sstd_garch_fit, sstd_gjr_fit)

# norm_garch_fit <- ugarchfit(data = funds_red$vanguard_return,
#                      spec = norm_garch_spec)
# 
# norm_gjr_fit <- ugarchfit(data = funds_red$vanguard_return,
#                      spec = norm_gjr_spec)
# 
# sstd_garch_fit <- ugarchfit(data = funds_red$vanguard_return,
#                      spec = sstd_garch_spec)
#   
# sstd_gjr_fit <- ugarchfit(data = funds_red$vanguard_return,
#                            spec = sstd_gjr_spec)
```

```{r}  
#Coefficients 

for (f in 1:length(garch_fits)) {
  cat('\nCoefficients of', names(garch_fits)[f], '\n')
  print(round(garch_fits[[f]]@fit$matcoef,10))

  cat('\nRobust coefficients of', names(garch_fits)[f], '\n')
  print(round(garch_fits[[f]]@fit$robust.matcoef,10))  
}
```


```{r}
# Visualizing impact of negative previous return on variance


p <- ggplot()

for (f in 1:length(garch_fits)) {
  garch_news <- as.data.frame(newsimpact(garch_fits[[f]])[1:2])
  
  model_name <- short_model_names[f]
  model_name <- enquo(model_name)
  
  p <- p + geom_line(data = garch_news, 
            aes(x = zx, y = zy, color = !!model_name))
}

p <- p + labs(x = 'Error', y = 'Variance', 
       title = 'Dependence of variance on errors in different models') +
  theme(plot.title = element_text(hjust = 0.5))

print(p)

rm(p, model_name, garch_news)

# norm_garch_news <- as.data.frame(newsimpact(norm_garch_fit)[1:2])
# norm_gjr_news <- as.data.frame(newsimpact(norm_gjr_fit) [1:2])
# sstd_garch_news <- as.data.frame(newsimpact(sstd_garch_fit)[1:2])
# sstd_gjr_news <- as.data.frame(newsimpact(sstd_gjr_fit)[1:2])

# ggplot() + 
#   geom_point(data = norm_garch_news, 
#              aes(x = zx, y =zy, color = 'Normal GARCH')) +
#   geom_line(data = norm_gjr_news, 
#             aes(x = zx, y = zy, color = 'Normal GJR')) +
#   geom_line(data = sstd_garch_news, 
#             aes(x = zx, y = zy, color = 'Skewed t GARCH')) +
#   geom_line(data = sstd_gjr_news, 
#             aes(x = zx, y = zy, color = 'Skewed t GJR')) +
  
```


```{r}
# Visualizing volatility
p <- ggplot()
garch_vol <- list()
for (f in 1:length(garch_fits)) {
  garch_vol[[f]] <- sigma(garch_fits[[f]])
  
  model_name <- short_model_names[f]
  model_name <- enquo(model_name)
  
  p <- p + geom_line(data = garch_vol[[f]], aes(x = index(garch_vol[[f]][,1]),
                                       y = garch_vol[[f]][,1],
                                       color = !!model_name), alpha = 0.2)
}
names(garch_vol) <- short_model_names

p <- p + geom_line(data = vol_df[,1], aes(y = vol_df[,1], x = index(vol_df[,1]),
                                   color = 'Actual volatility')) +
     labs(x = 'Date', y = 'Volatility', 
          title = 'Volatility constructed by different models') +
     theme(plot.title = element_text(hjust = 0.5))

suppressMessages(suppressWarnings(print(p)))
rm(p, f, model_name)
```

```{r}
# Predicting volatility for n.ahead periods

norm_garch_forecast <- ugarchforecast(fitORspec = norm_garch_fit,
                                      data = norm_garch_vol, n.ahead = 10)
norm_gjr_forecast <- ugarchforecast(fitORspec = norm_gjr_fit,
                                      data = norm_gjr_vol, n.ahead = 10)
sstd_garch_forecast <- ugarchforecast(fitORspec = sstd_garch_fit,
                                      data = sstd_garch_vol, n.ahead = 10)
sstd_gjr_forecast <- ugarchforecast(fitORspec = sstd_gjr_fit,
                                      data = sstd_gjr_vol, n.ahead = 10)
```


```{r}
# 252 - number of working days in year
#van_norm_res <- sigma(van_forecast) #* sqrt(252)

# garch_for_funds <- function(funds) {
#   for (i in 1:ncol(funds)) {
#     return()
#   }
# }

```

```{r}
# chart.Histogram(residuals(van_sstd_fit, standardize = T),
#                 methods = c('add.normal', 'add.density', 'add.student'))
```

```{r}
# cat('SST for norm\n')
# sum(vanguard_tail_volatility - van_norm_res)
# 
# cat('\nSST for sstd\n')
# sum(vanguard_tail_volatility - van_sstd_res)
# 
# cbind(vanguard_tail_volatility, van_norm_res, van_sstd_res)
```


```{r}
# vanguard_std <- (funds$vanguard_return - mean(funds$vanguard_return))/sd(funds$vanguard_return)
# 
# ggplot(data = data.frame(x = c(-10, 10)), aes(x)) +
#   stat_function(fun = dnorm, n = 4800, args = list(mean = 0, sd = 3)
#                 , aes(x = x,colour = 'Normal')) + ylab("") +
#   scale_y_continuous(breaks = NULL) +
#   stat_function(fun = dskt,  n = 4800, args = list(df = 100, gamma = 1.2),
#                 aes(colour = 'Skewed Student t')) +
#   geom_histogram(data = vanguard_std, aes(x = vanguard_std,y = ..density..), bins = 100, alpha = 0.3)

```

